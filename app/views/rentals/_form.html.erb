<%= form_with(model: rental, class: "row g-3") do |form| %>
  <% if rental.errors.any? %>
    <div class="alert alert-danger" role="alert">
      <h2><%= pluralize(rental.errors.count, "error") %> impediram o salvamento deste empréstimo:</h2>
      <ul>
        <% rental.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= hidden_field_tag :book_id, nil, id: "book_id" %>
  <%= hidden_field_tag :user_id, nil, id: "user_id" %>

  <div class="col-md-6">
    <%= label_tag :book_name, "Nome do Livro", class: "form-label" %>
    <div class="input-group">
      <%= text_field_tag :book_name, nil, id: "book_name", class: "form-control" %>
      <button class="btn btn-outline-secondary" type="button" id="search_book">
        <i class="bi bi-search"></i> Buscar Livro
      </button>
    </div>
  </div>

  <div id="book_info" class="col-md-12" style="display: none; margin-top: 10px;">
    <h3>Informações do Livro</h3>
    <p><strong>Título:</strong> <span id="book_title"></span></p>
    <p><strong>Autor(es):</strong> <span id="book_authors"></span></p>
    <p><strong>Gênero(s):</strong> <span id="book_genres"></span></p>
    <p><strong>Quantidade disponível:</strong> <span id="book_quanty"></span></p>
  </div>
  <p id="book_error" class="text-danger" style="display: none;">Livro não encontrado.</p>

  <hr class="my-4">

  <div class="col-md-6">
    <%= label_tag :user_registration, "Matrícula do Usuário", class: "form-label" %>
    <div class="input-group">
      <%= text_field_tag :user_registration, nil, id: "user_registration", class: "form-control" %>
      <button class="btn btn-outline-secondary" type="button" id="search_user">
        <i class="bi bi-search"></i> Buscar Usuário
      </button>
    </div>
  </div>

  <div id="user_info" class="col-md-12" style="display: none; margin-top: 10px;">
    <h3>Informações do Usuário</h3>
    <p><strong>Nome:</strong> <span id="user_name"></span></p>
    <p><strong>Email:</strong> <span id="user_email"></span></p>
    <p><strong>Habilitado:</strong>
      <span id="user_habilitaded">
      </span>
    </p>
  </div>
  <p id="user_error" class="text-danger" style="display: none;">Usuário não encontrado.</p>

  <hr class="my-4">

  <div class="col-md-4">
      <%= form.label :rental_date, "Data de Empréstimo", class: "form-label" %>
      <%= form.date_field :rental_date, class: "form-control" %>
  </div>

  <div class="col-md-4">
    <%= form.label :return_estimate_date, "Data Estimada de Devolução", class: "form-label" %>
    <%= form.date_field :return_estimate_date, class: "form-control" %>
  </div>

  <div class="col-md-4">
    <%= form.label :return_date, "Data de Devolução Efetiva", class: "form-label" %>
    <%= form.date_field :return_date, class: "form-control" %>
  </div>

  <hr class="my-4">

  <div class="col-12">
    <%= form.submit "Salvar Empréstimo", class: "btn btn-primary" %>
    <%= link_to "Cancelar", rentals_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Existing JavaScript code for searching books and users...
    document.getElementById("search_book").addEventListener("click", function() {
        const bookName = document.getElementById("book_name").value;

        fetch(`/books/search?title=${bookName}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)
                if (data.error) {
                    document.getElementById("book_error").style.display = "block";
                    document.getElementById("book_info").style.display = "none";
                } else {
                    document.getElementById("book_error").style.display = "none";
                    document.getElementById("book_info").style.display = "block";
                    document.getElementById("book_title").textContent = data.title;
                    document.getElementById("book_authors").textContent = data.authors.join(", ");
                    document.getElementById("book_genres").textContent = data.genres.join(", ");
                    document.getElementById("book_quanty").textContent = data.quanty;
                    document.getElementById("book_id").value = data.id;
                }
            });
    });

    document.getElementById("search_user").addEventListener("click", function() {
        const userRegistration = document.getElementById("user_registration").value;

        fetch(`/users/search?registration=${userRegistration}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)
                if (data.error) {
                    document.getElementById("user_error").style.display = "block";
                    document.getElementById("user_info").style.display = "none";
                } else {
                    document.getElementById("user_error").style.display = "none";
                    document.getElementById("user_info").style.display = "block";
                    document.getElementById("user_name").textContent = data.name;
                    document.getElementById("user_email").textContent = data.email;
                    document.getElementById("user_habilitaded").textContent = (data.habilitaded ? "sim" : "não");
                    document.getElementById("user_id").value = data.id;
                }
            });
    });


    document.getElementById("confirm_rental").addEventListener("click", function(event) {
        const bookId = document.getElementById("book_id").value;
        const userId = document.getElementById("user_id").value;

        if (!bookId || !userId) {
            alert("Por favor, selecione um livro e um usuário antes de confirmar o empréstimo.");
            event.preventDefault(); // Impede o envio do formulário se os campos estiverem vazios
        }
    });
  });
</script>